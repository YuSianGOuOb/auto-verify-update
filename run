#!/bin/bash

IMAGE_NAME="auto-verify-update"
CONFIG_DIR="$(pwd)/config"
IMG_DIR="$(pwd)/img"

# 顯示幫助訊息
function show_help {
    echo "Usage: ./run [options]"
    echo ""
    echo "Options:"
    echo "  --build                      Force rebuild the Docker image"
    echo "  -v, --verify                 Run in Verification Only mode (skip updates)"
    echo "  -c, --config <file>          Path to specific config file (default: config/inventory.yaml)"
    echo "  -h, --help                   Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./run --build                            # First time setup (Builds Docker environment)"
    echo "  ./run                                    # Standard update (uses default config)"
    echo "  ./run -v                                 # Verify only (uses default config)"
    echo "  ./run -c config/server_b.yaml            # Update with specific config"
    echo "  ./run -v -c config/server_b.yaml         # Verify with specific config"
    echo "  ./run -c config/cpld_only.yaml           # Single component test"
    echo ""
}

# 檢查參數
ARGS=()
BUILD_FLAG=false

for arg in "$@"; do
    case $arg in
        -h|--help)
            show_help
            exit 0
            ;;
        --build)
            BUILD_FLAG=true
            ;;
        *)
            ARGS+=("$arg")
            ;;
    esac
done

# 建置 Docker Image (若不存在或指定 --build)
if [[ "$(docker images -q $IMAGE_NAME 2> /dev/null)" == "" ]] || [ "$BUILD_FLAG" = true ]; then
    echo "Building Docker image..."
    docker build -t $IMAGE_NAME .
fi

# 執行 Container
# 直接將參數透傳給 python main.py
# 優化後的 docker run
docker run --rm -it \
  -v "$(pwd)":/app \
  $IMAGE_NAME \
  python main.py "${ARGS[@]}"