#!/bin/bash

set -e

IMAGE_NAME="bmc-update-env"

# 1. 建置映像檔
if [[ "$1" == "--build" ]]; then
    echo "[INFO] Building Docker image..."
    docker build -t $IMAGE_NAME .
    exit 0
fi

# 2. 顯示使用說明
if [[ "$1" == "-h" ]]; then
    echo "Usage:"
    echo "  ./run                       # Update with default config"
    echo "  ./run -v                    # Verify versions ONLY (Default config)"
    echo "  ./run config/my.yaml        # Update with specific config"
    echo "  ./run -v config/my.yaml     # Verify versions with specific config"
    echo "  ./run --build               # Rebuild Docker image"
    exit 0
fi

# 3. 參數解析
CONFIG_PATH="config/inventory.yaml"
PYTHON_FLAGS=""

# 迴圈檢查所有參數 ($@)
for arg in "$@"; do
    if [[ "$arg" == -* ]]; then
        # 如果是 flag (如 -v)，加入 PYTHON_FLAGS
        PYTHON_FLAGS="$PYTHON_FLAGS $arg"
    else
        # 如果不是 flag，認定為 Config 路徑
        CONFIG_PATH="$arg"
    fi
done

echo "[INFO] Configuration: $CONFIG_PATH"
if [[ ! -z "$PYTHON_FLAGS" ]]; then
    echo "[INFO] Flags: $PYTHON_FLAGS"
fi

# 4. 執行 Docker
# 將 flags 與 config 傳給 main.py
# -v "$(pwd)":/app : 掛載當前目錄
docker run --rm -it \
    -v "$(pwd)":/app \
    -w /app \
    $IMAGE_NAME \
    python3 main.py $PYTHON_FLAGS --config "$CONFIG_PATH"